generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String   @id @default(cuid())
  name           String?
  email          String   @unique
  phone          String?
  passwordHash   String?
  role           Role     @default(CLIENT)

  referralCode   String?  @unique
  referredById   String?
  referredBy     User?    @relation("UserReferrals", fields: [referredById], references: [id])
  referrals      User[]   @relation("UserReferrals")
  referralCommissionRate Float @default(0.1)

  balance        Decimal  @default(0) @db.Decimal(12, 2)

  orders         Order[]
  referralTracks ReferralTracking[]
  referralUserTracks ReferralTracking[] @relation("ReferralUser")
  auditLogs      AuditLog[] @relation("UserAuditLogs")
  customRequests CustomProjectRequest[]
  phaseAssetsCreated PhaseAsset[] @relation("PhaseAssetCreator")
  phaseCommentsAuthored PhaseComment[] @relation("PhaseCommentAuthor")
  changeRequestsCreated ChangeRequest[] @relation("ChangeRequestCreator")

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Service {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  description String?
  priceBase   Decimal  @db.Decimal(12, 2)
  isActive    Boolean  @default(true)

  orders      Order[]
  templateSites TemplateSite[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model TemplateSite {
  id               String         @id @default(cuid())
  serviceId        String
  service          Service        @relation(fields: [serviceId], references: [id])

  title            String
  slug             String         @unique
  category         String?
  shortDescription String?
  longDescription  String?

  basePrice        Decimal        @db.Decimal(12, 2)
  currency         String         @default("USD")

  demoUrl          String?
  thumbUrl         String?
  laptopPreviewImage String?
  tabletPreviewImage String?
  mobilePreviewImage String?
  gallery          TemplateMedia[]

  isActive         Boolean        @default(true)

  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
}

model TemplateMedia {
  id           String       @id @default(cuid())
  templateId   String
  template     TemplateSite @relation(fields: [templateId], references: [id])

  url          String
  publicId     String?
  label        String?
  createdAt    DateTime     @default(now())
}

model Order {
  id          String      @id @default(cuid())
  userId      String
  user        User        @relation(fields: [userId], references: [id])

  serviceId   String
  service     Service     @relation(fields: [serviceId], references: [id])

  status      OrderStatus @default(PENDING)
  totalAmount Decimal     @db.Decimal(12, 2)
  archivedAt  DateTime?

  addOns      OrderAddOn[]   // NEW: template extras / price adjustments

  projects    Project[]
  referralTracks ReferralTracking[]
  customProjectRequest CustomProjectRequest?

  createdAt   DateTime    @default(now())
}

model OrderAddOn {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id])

  title     String
  amount    Decimal  @db.Decimal(12, 2)

  createdAt DateTime @default(now())
}

model Project {
  id           String           @id @default(cuid())
  orderId      String
  order        Order            @relation(fields: [orderId], references: [id])

  title        String
  description  String?
  status       ProjectStatus    @default(REQUIREMENTS)
  dueDate      DateTime?
  archivedAt   DateTime?

  phases       ProjectPhase[]
  changeRequests ChangeRequest[]
  milestonePayments MilestonePayment[]
  invoices     Invoice[]
  revisions    PaidRevisionRequest[]
  media        ProjectMedia[]

  review       Review?          // NEW: client rating/comment for this project

  portfolioItems PortfolioItem[] // NEW: optional publishing to portfolio

  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
}

model MilestonePayment {
  id          String           @id @default(cuid())
  projectId   String
  project     Project          @relation(fields: [projectId], references: [id])

  label       String
  amount      Decimal         @db.Decimal(12, 2)
  status      MilestoneStatus  @default(PENDING)
  proofUrl    String?
  reviewedBy  String?
  reviewedAt  DateTime?
  dueDate     DateTime?
  gatePhaseId String?
  gatePhase   ProjectPhase?    @relation(fields: [gatePhaseId], references: [id])
  changeRequestId String?
  changeRequest ChangeRequest? @relation(fields: [changeRequestId], references: [id])
  archivedAt  DateTime?

  createdAt   DateTime         @default(now())
}

model ProjectPhase {
  id          String        @id @default(cuid())
  projectId   String
  project     Project       @relation(fields: [projectId], references: [id])
  group       ProjectStatus
  title       String
  description String?
  dueDate     DateTime?
  status      PhaseStatus   @default(PENDING)
  order       Int           @default(0)

  deliverables PhaseAsset[]
  comments     PhaseComment[]
  payments     MilestonePayment[]

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model PhaseAsset {
  id          String         @id @default(cuid())
  phaseId     String
  phase       ProjectPhase   @relation(fields: [phaseId], references: [id])
  type        PhaseAssetType @default(IMAGE)
  url         String
  label       String?
  createdById String?
  createdBy   User?          @relation("PhaseAssetCreator", fields: [createdById], references: [id])
  createdAt   DateTime       @default(now())
}

model PhaseComment {
  id        String       @id @default(cuid())
  phaseId   String
  phase     ProjectPhase @relation(fields: [phaseId], references: [id])
  authorId  String?
  author    User?        @relation("PhaseCommentAuthor", fields: [authorId], references: [id])
  body      String
  attachments PhaseCommentAsset[]
  createdAt DateTime     @default(now())
}

model PhaseCommentAsset {
  id        String       @id @default(cuid())
  commentId String
  comment   PhaseComment @relation(fields: [commentId], references: [id])
  url       String
  label     String?
  createdAt DateTime     @default(now())
}

model ChangeRequest {
  id          String              @id @default(cuid())
  projectId   String
  project     Project             @relation(fields: [projectId], references: [id])
  title       String
  description String?
  amount      Decimal            @db.Decimal(12, 2)
  status      ChangeRequestStatus @default(PENDING)
  createdById String?
  createdBy   User?               @relation("ChangeRequestCreator", fields: [createdById], references: [id])
  decidedAt   DateTime?
  createdAt   DateTime            @default(now())
  payments    MilestonePayment[]
}

model Invoice {
  id          String          @id @default(cuid())
  projectId   String
  project     Project         @relation(fields: [projectId], references: [id])

  amountDue   Decimal        @db.Decimal(12, 2)
  amountPaid  Decimal        @default(0) @db.Decimal(12, 2)
  currency    String          @default("USD")
  status      InvoiceStatus   @default(UNPAID)
  pdfUrl      String?

  issuedAt    DateTime        @default(now())
  dueAt       DateTime?
}

model PaidRevisionRequest {
  id          String              @id @default(cuid())
  projectId   String
  project     Project             @relation(fields: [projectId], references: [id])

  title       String
  details     String?
  amount      Decimal            @db.Decimal(12, 2)
  status      RevisionStatus      @default(PENDING)
  attachmentUrl String?
  sessionAt   DateTime?
  sessionDurationMinutes Int?
  sessionNotes String?
  sessionLinks Json?
  paymentProofUrl String?
  clientProposedAt DateTime?
  clientProposedDurationMinutes Int?
  clientProposedNote String?
  completedAt DateTime?

  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
}

model ReferralTracking {
  id               String          @id @default(cuid())
  referrerId       String
  referrer         User            @relation(fields: [referrerId], references: [id])

  referredUserId   String?
  referredUser     User?           @relation("ReferralUser", fields: [referredUserId], references: [id])

  commissionAmount Decimal         @default(0) @db.Decimal(12, 2)
  commissionRate   Float           @default(0.1)
  commissionPaidOut Decimal        @default(0) @db.Decimal(12, 2)
  status           ReferralStatus  @default(PENDING)

  orderId          String?
  order            Order?          @relation(fields: [orderId], references: [id])

  createdAt        DateTime        @default(now())
}

model ProjectMedia {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id])
  url       String
  publicId  String
  createdAt DateTime @default(now())
}

model CustomProjectRequest {
  id             String               @id @default(cuid())
  userId         String?
  user           User?                @relation(fields: [userId], references: [id])

  fullName       String
  email          String
  phone          String?
  companyName    String?
  businessType   String?

  projectType    String?
  languages      String?
  hasDomain      Boolean?
  hasHosting     Boolean?

  budgetRange    String?
  timeline       String?
  referenceLinks String?
  details        String

  status         CustomRequestStatus  @default(PENDING)

  orderId        String?              @unique
  order          Order?               @relation(fields: [orderId], references: [id])

  quotes         Quote[]              // NEW: quotes for this request

  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
}

model Quote {
  id               String   @id @default(cuid())

  customRequestId  String
  customRequest    CustomProjectRequest @relation(fields: [customRequestId], references: [id])

  amount           Decimal  @db.Decimal(12, 2)
  currency         String   @default("USD")
  scope            String

  status           QuoteStatus @default(DRAFT)

  magicToken       String   @unique
  expiresAt        DateTime
  archivedAt       DateTime?

  sentAt           DateTime?
  acceptedAt       DateTime?
  rejectedAt       DateTime?

  createdAt        DateTime @default(now())
}

model Review {
  id        String   @id @default(cuid())
  projectId String   @unique
  project   Project  @relation(fields: [projectId], references: [id])

  rating    Int      // 1..5
  comment   String?

  isPublic  Boolean  @default(false)

  createdAt DateTime @default(now())
}

model PortfolioItem {
  id          String   @id @default(cuid())

  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id])

  title       String
  slug        String   @unique
  description String?
  fullDescription String?
  projectType String?
  category    String?
  concept     String?
  clientGoal  String?
  problem     String?
  solution    String?
  keyFeatures Json?

  coverImage  String?
  gallery     Json?
  videoUrl    String?
  liveUrl     String?
  laptopPreviewImage String?
  tabletPreviewImage String?
  mobilePreviewImage String?
  locale      String   @default("en")
  isPublished Boolean  @default(false)
  publishedAt DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model FrontEndSnippet {
  id          String   @id @default(cuid())
  title       String
  description String?
  slug        String   @unique
  html        String
  css         String
  js          String
  status      SnippetStatus @default(DRAFT)

  tags        FrontEndSnippetTag[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SnippetTag {
  id        String   @id @default(cuid())
  name      String
  category  SnippetTagCategory

  snippets  FrontEndSnippetTag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, category])
}

model FrontEndSnippetTag {
  snippetId String
  tagId     String

  snippet   FrontEndSnippet @relation(fields: [snippetId], references: [id])
  tag       SnippetTag       @relation(fields: [tagId], references: [id])

  @@id([snippetId, tagId])
}

model AuditLog {
  id        String   @id @default(cuid())
  actorId   String?
  actor     User?    @relation("UserAuditLogs", fields: [actorId], references: [id])

  action    String
  targetType String
  targetId  String?
  data      Json?

  createdAt DateTime @default(now())
}

model BlogPost {
  id             String     @id @default(cuid())
  title          String
  slug           String     @unique
  excerpt        String
  content        String
  coverImage     String?
  category       String
  tags           String[]
  status         BlogStatus @default(DRAFT)
  locale         String     @default("en")
  featured       Boolean    @default(false)
  authorName     String?
  seoTitle       String?
  seoDescription String?
  readingTime    Int?
  publishedAt    DateTime?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
}

model CaseStudy {
  id               String           @id @default(cuid())
  title            String
  slug             String           @unique
  clientName       String
  projectType      String
  industry         String?
  duration         String?
  technologies     String[]
  coverImage       String?
  challengeSummary String
  primaryResult    String
  challenge        String
  solution         String
  implementation   String
  results          Json?
  testimonial      String?
  status           CaseStudyStatus  @default(DRAFT)
  locale           String           @default("en")
  featured         Boolean          @default(false)
  publishedAt      DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
}

enum CustomRequestStatus {
  PENDING
  REVIEWED
  CONVERTED_TO_ORDER
  REJECTED
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
}

enum Role {
  ADMIN
  PARTNER
  CLIENT
}

enum OrderStatus {
  PENDING
  IN_PROGRESS
  DELIVERED
  CANCELLED
}

enum ProjectStatus {
  REQUIREMENTS
  DESIGN
  DEV
  QA
  DELIVERED
}

enum MilestoneStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
}

enum PhaseStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  BLOCKED
}

enum PhaseAssetType {
  IMAGE
  LINK
}

enum InvoiceStatus {
  UNPAID
  PARTIAL
  PAID
}

enum RevisionStatus {
  PENDING
  IN_PROGRESS
  DELIVERED
  REJECTED
}

enum ReferralStatus {
  PENDING
  EARNED
  PAID_OUT
}

enum ChangeRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum BlogStatus {
  DRAFT
  PUBLISHED
}

enum CaseStudyStatus {
  DRAFT
  PUBLISHED
}

enum SnippetStatus {
  DRAFT
  PUBLISHED
}

enum SnippetTagCategory {
  COMPONENT
  STYLE
  INTERACTION
  LAYOUT
  TECH
  COLOR
  USE_CASE
}
